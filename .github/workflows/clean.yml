name: Cleanup Old Workflow Runs

on:
  workflow_dispatch: # æ‰‹åŠ¨è§¦å‘

jobs:
  cleanup:
    runs-on: ubuntu-latest

    steps:
      - name: å®‰è£…ä¾èµ–
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: ç™»å½• GitHub CLI
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ä½¿ç”¨ GITHUB_TOKEN ç™»å½•"
          echo "${GH_TOKEN}" | gh auth login --with-token

      - name: åˆ é™¤ 2 å¤©å‰çš„å·¥ä½œæµè¿è¡Œè®°å½•
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          THRESHOLD="$(date -u -d '2 days ago' '+%Y-%m-%dT%H:%M:%SZ')"
          echo "åˆ é™¤æ—©äº $THRESHOLD çš„è¿è¡Œè®°å½•..."
          
          while true; do
            RUN_IDS=$(gh run list -R "${GITHUB_REPOSITORY}" --limit 100 --json databaseId,createdAt \
              | jq -r --arg TH "$THRESHOLD" '.[] | select(.createdAt < $TH) | .databaseId')
            
            if [ -z "$RUN_IDS" ]; then
              echo "âœ… æ²¡æœ‰æ›´å¤šéœ€è¦åˆ é™¤çš„è®°å½•"
              break
            fi

            for ID in $RUN_IDS; do
              echo "ğŸ—‘ åˆ é™¤è¿è¡Œè®°å½• ID: $ID"
              gh run delete "$ID" -R "${GITHUB_REPOSITORY}" --confirm
            done
          done
