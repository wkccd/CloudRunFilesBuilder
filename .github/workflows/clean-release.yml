name: Cleanup Old Releases

on:
  schedule:
    # æ¯å‘¨ä¸€å‡Œæ™¨ 1 ç‚¹ï¼ˆUTCï¼‰ï¼ŒåŒ—äº¬æ—¶é—´å‘¨ä¸€æ—©ä¸Š 9 ç‚¹
    - cron: "0 1 * * 1"

  workflow_dispatch:
    inputs:
      keep_days:
        description: "ä¿ç•™æœ€è¿‘å¤šå°‘å¤©ï¼ˆé»˜è®¤ 2ï¼‰"
        required: false
        default: "2"

jobs:
  cleanup_releases:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: æ¸…ç†æŒ‡å®šå¤©æ•°å‰çš„ Release å’Œ Tag
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          KEEP_DAYS: ${{ github.event.inputs.keep_days }}
        run: |
          : "${KEEP_DAYS:=30}"
          THRESHOLD="$(date -u -d "${KEEP_DAYS} days ago" '+%Y-%m-%dT%H:%M:%SZ')"
          echo "é˜ˆå€¼æ—¶é—´(UTC)ï¼š$THRESHOLD"

          # è·å–éœ€è¦åˆ é™¤çš„ release ID
          RELEASE_IDS=$(gh api -X GET "repos/${GITHUB_REPOSITORY}/releases" \
                        --paginate -F per_page=100 \
                        --jq '.[] | select(.created_at < "'"$THRESHOLD"'") | .id')

          if [ -z "$RELEASE_IDS" ]; then
            echo "âœ… æ²¡æœ‰å¯åˆ é™¤çš„ Release"
            exit 0
          fi

          echo "å¾…åˆ é™¤ Release æ•°é‡ï¼š$(wc -w <<< "$RELEASE_IDS")"

          for ID in $RELEASE_IDS; do
            # è·å– release åç§°å’Œ tag
            NAME=$(gh api -X GET "repos/${GITHUB_REPOSITORY}/releases/${ID}" --jq '.name')
            TAG_NAME=$(gh api -X GET "repos/${GITHUB_REPOSITORY}/releases/${ID}" --jq -r '.tag_name')

            echo "ğŸ—‘ åˆ é™¤ Release: $NAME (ID: $ID)"
            gh api -X DELETE "repos/${GITHUB_REPOSITORY}/releases/${ID}" || {
              echo "âš ï¸ åˆ é™¤ Release å¤±è´¥ï¼š$IDï¼ˆç»§ç»­åˆ é™¤ä¸‹ä¸€ä¸ªï¼‰"
            }

            # åˆ é™¤å¯¹åº” tag
            if [ "$TAG_NAME" != "null" ] && [ -n "$TAG_NAME" ]; then
              echo "ğŸ—‘ åˆ é™¤ Tag: $TAG_NAME"
              gh api -X DELETE "repos/${GITHUB_REPOSITORY}/git/refs/tags/$TAG_NAME" || {
                echo "âš ï¸ åˆ é™¤ Tag å¤±è´¥ï¼š$TAG_NAMEï¼ˆç»§ç»­ä¸‹ä¸€ä¸ªï¼‰"
              }
            else
              echo "âš ï¸ Release $NAME æ²¡æœ‰å…³è” Tagï¼Œè·³è¿‡åˆ é™¤ Tag"
            fi

            sleep 0.5
          done

          echo "ğŸ‰ Release + Tag æ¸…ç†å®Œæˆ"
