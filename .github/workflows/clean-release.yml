name: Cleanup Old Releases

on:
  schedule:
    # æ¯å‘¨ä¸€ 01:00 UTCï¼ˆåŒ—äº¬æ—¶é—´å‘¨ä¸€ 09:00ï¼‰
    - cron: "0 1 * * 1"

  workflow_dispatch:
    inputs:
      keep_days:
        description: "ä¿ç•™æœ€è¿‘å¤šå°‘å¤©ï¼ˆé»˜è®¤ 2ï¼‰"
        required: false
        default: "2"

jobs:
  cleanup_releases:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Cleanup old releases and tags
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          KEEP_DAYS: ${{ github.event.inputs.keep_days }}
        run: |
          set -euo pipefail
          export LANG=C.UTF-8
          export LC_ALL=C.UTF-8

          # é»˜è®¤å€¼ä¸æ ¡éªŒï¼ˆå®šæ—¶è§¦å‘æ—¶ inputs ä¸ºç©ºï¼Œè¿™é‡Œå…œåº•ï¼‰
          KEEP_DAYS="${KEEP_DAYS:-2}"
          if ! [[ "$KEEP_DAYS" =~ ^[0-9]+$ ]]; then
            echo "KEEP_DAYS is not a number, fallback to 2"
            KEEP_DAYS=2
          fi

          THRESHOLD="$(date -u -d "${KEEP_DAYS} days ago" '+%Y-%m-%dT%H:%M:%SZ')"
          echo "Threshold time (UTC): $THRESHOLD"

          # ä¸€æ¬¡æ€§æ‹‰å–æ‰€æœ‰è¶…å‡ºé˜ˆå€¼çš„ release æ‰€éœ€å­—æ®µï¼ˆidã€nameã€tag_nameï¼‰
          TO_DELETE="$(gh api --paginate "repos/${GITHUB_REPOSITORY}/releases" \
            --jq '.[] | select(.created_at < "'"$THRESHOLD"'") | [.id, (.name // ""), (.tag_name // "")] | @tsv' || true)"

          if [ -z "$TO_DELETE" ]; then
            echo "âœ… No releases to delete"
            exit 0
          fi

          COUNT="$(printf '%s\n' "$TO_DELETE" | sed '/^$/d' | wc -l)"
          echo "Releases to delete: $COUNT"

          # é€è¡Œè¯»å…¥ï¼šID \t NAME \t TAG_NAME
          printf '%s\n' "$TO_DELETE" | while IFS=$'\t' read -r ID NAME TAG_NAME; do
            echo "ğŸ—‘ Deleting Release: ${NAME:-<no name>} (ID: $ID)"
            gh api -X DELETE "repos/${GITHUB_REPOSITORY}/releases/${ID}" || {
              echo "âš ï¸ Failed to delete Release: $ID (continue)"; 
            }

            if [ -n "${TAG_NAME:-}" ] && [ "$TAG_NAME" != "null" ]; then
              echo "ğŸ—‘ Deleting Tag: $TAG_NAME"
              gh api -X DELETE "repos/${GITHUB_REPOSITORY}/git/refs/tags/$TAG_NAME" || {
                echo "âš ï¸ Failed to delete Tag: $TAG_NAME (continue)";
              }
            else
              echo "âš ï¸ No tag for release ID $ID, skipping tag deletion"
            fi

            sleep 1
          done

          echo "ğŸ‰ Cleanup complete"
